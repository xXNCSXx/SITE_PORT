{"ast":null,"code":"import { buildAlternativesLookAheadFunc, buildLookaheadFuncForOptionalProd, buildLookaheadFuncForOr, buildSingleAlternativeLookaheadFunction, PROD_TYPE } from \"../../grammar/lookahead\";\nimport { forEach, has, isES2015MapSupported } from \"../../../utils/utils\";\nimport { DEFAULT_PARSER_CONFIG } from \"../parser\";\nimport { AT_LEAST_ONE_IDX, AT_LEAST_ONE_SEP_IDX, getKeyForAutomaticLookahead, MANY_IDX, MANY_SEP_IDX, OPTION_IDX, OR_IDX } from \"../../grammar/keys\";\nimport { collectMethods, getProductionDslName } from \"../../grammar/gast/gast\";\n/**\n * Trait responsible for the lookahead related utilities and optimizations.\n */\nvar LooksAhead = /** @class */function () {\n  function LooksAhead() {}\n  LooksAhead.prototype.initLooksAhead = function (config) {\n    this.dynamicTokensEnabled = has(config, \"dynamicTokensEnabled\") ? config.dynamicTokensEnabled : DEFAULT_PARSER_CONFIG.dynamicTokensEnabled;\n    this.maxLookahead = has(config, \"maxLookahead\") ? config.maxLookahead : DEFAULT_PARSER_CONFIG.maxLookahead;\n    /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n    this.lookAheadFuncsCache = isES2015MapSupported() ? new Map() : [];\n    // Performance optimization on newer engines that support ES6 Map\n    // For larger Maps this is slightly faster than using a plain object (array in our case).\n    /* istanbul ignore else - The else branch will be tested on older node.js versions and IE11 */\n    if (isES2015MapSupported()) {\n      this.getLaFuncFromCache = this.getLaFuncFromMap;\n      this.setLaFuncCache = this.setLaFuncCacheUsingMap;\n    } else {\n      this.getLaFuncFromCache = this.getLaFuncFromObj;\n      this.setLaFuncCache = this.setLaFuncUsingObj;\n    }\n  };\n  LooksAhead.prototype.preComputeLookaheadFunctions = function (rules) {\n    var _this = this;\n    forEach(rules, function (currRule) {\n      _this.TRACE_INIT(currRule.name + \" Rule Lookahead\", function () {\n        var _a = collectMethods(currRule),\n          alternation = _a.alternation,\n          repetition = _a.repetition,\n          option = _a.option,\n          repetitionMandatory = _a.repetitionMandatory,\n          repetitionMandatoryWithSeparator = _a.repetitionMandatoryWithSeparator,\n          repetitionWithSeparator = _a.repetitionWithSeparator;\n        forEach(alternation, function (currProd) {\n          var prodIdx = currProd.idx === 0 ? \"\" : currProd.idx;\n          _this.TRACE_INIT(\"\" + getProductionDslName(currProd) + prodIdx, function () {\n            var laFunc = buildLookaheadFuncForOr(currProd.idx, currRule, currProd.maxLookahead || _this.maxLookahead, currProd.hasPredicates, _this.dynamicTokensEnabled, _this.lookAheadBuilderForAlternatives);\n            var key = getKeyForAutomaticLookahead(_this.fullRuleNameToShort[currRule.name], OR_IDX, currProd.idx);\n            _this.setLaFuncCache(key, laFunc);\n          });\n        });\n        forEach(repetition, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, MANY_IDX, PROD_TYPE.REPETITION, currProd.maxLookahead, getProductionDslName(currProd));\n        });\n        forEach(option, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, OPTION_IDX, PROD_TYPE.OPTION, currProd.maxLookahead, getProductionDslName(currProd));\n        });\n        forEach(repetitionMandatory, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, AT_LEAST_ONE_IDX, PROD_TYPE.REPETITION_MANDATORY, currProd.maxLookahead, getProductionDslName(currProd));\n        });\n        forEach(repetitionMandatoryWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, AT_LEAST_ONE_SEP_IDX, PROD_TYPE.REPETITION_MANDATORY_WITH_SEPARATOR, currProd.maxLookahead, getProductionDslName(currProd));\n        });\n        forEach(repetitionWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, MANY_SEP_IDX, PROD_TYPE.REPETITION_WITH_SEPARATOR, currProd.maxLookahead, getProductionDslName(currProd));\n        });\n      });\n    });\n  };\n  LooksAhead.prototype.computeLookaheadFunc = function (rule, prodOccurrence, prodKey, prodType, prodMaxLookahead, dslMethodName) {\n    var _this = this;\n    this.TRACE_INIT(\"\" + dslMethodName + (prodOccurrence === 0 ? \"\" : prodOccurrence), function () {\n      var laFunc = buildLookaheadFuncForOptionalProd(prodOccurrence, rule, prodMaxLookahead || _this.maxLookahead, _this.dynamicTokensEnabled, prodType, _this.lookAheadBuilderForOptional);\n      var key = getKeyForAutomaticLookahead(_this.fullRuleNameToShort[rule.name], prodKey, prodOccurrence);\n      _this.setLaFuncCache(key, laFunc);\n    });\n  };\n  LooksAhead.prototype.lookAheadBuilderForOptional = function (alt, tokenMatcher, dynamicTokensEnabled) {\n    return buildSingleAlternativeLookaheadFunction(alt, tokenMatcher, dynamicTokensEnabled);\n  };\n  LooksAhead.prototype.lookAheadBuilderForAlternatives = function (alts, hasPredicates, tokenMatcher, dynamicTokensEnabled) {\n    return buildAlternativesLookAheadFunc(alts, hasPredicates, tokenMatcher, dynamicTokensEnabled);\n  };\n  // this actually returns a number, but it is always used as a string (object prop key)\n  LooksAhead.prototype.getKeyForAutomaticLookahead = function (dslMethodIdx, occurrence) {\n    var currRuleShortName = this.getLastExplicitRuleShortName();\n    return getKeyForAutomaticLookahead(currRuleShortName, dslMethodIdx, occurrence);\n  };\n  /* istanbul ignore next */\n  LooksAhead.prototype.getLaFuncFromCache = function (key) {\n    return undefined;\n  };\n  LooksAhead.prototype.getLaFuncFromMap = function (key) {\n    return this.lookAheadFuncsCache.get(key);\n  };\n  /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n  LooksAhead.prototype.getLaFuncFromObj = function (key) {\n    return this.lookAheadFuncsCache[key];\n  };\n  /* istanbul ignore next */\n  LooksAhead.prototype.setLaFuncCache = function (key, value) {};\n  LooksAhead.prototype.setLaFuncCacheUsingMap = function (key, value) {\n    this.lookAheadFuncsCache.set(key, value);\n  };\n  /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n  LooksAhead.prototype.setLaFuncUsingObj = function (key, value) {\n    this.lookAheadFuncsCache[key] = value;\n  };\n  return LooksAhead;\n}();\nexport { LooksAhead };","map":{"version":3,"names":["buildAlternativesLookAheadFunc","buildLookaheadFuncForOptionalProd","buildLookaheadFuncForOr","buildSingleAlternativeLookaheadFunction","PROD_TYPE","forEach","has","isES2015MapSupported","DEFAULT_PARSER_CONFIG","AT_LEAST_ONE_IDX","AT_LEAST_ONE_SEP_IDX","getKeyForAutomaticLookahead","MANY_IDX","MANY_SEP_IDX","OPTION_IDX","OR_IDX","collectMethods","getProductionDslName","LooksAhead","prototype","initLooksAhead","config","dynamicTokensEnabled","maxLookahead","lookAheadFuncsCache","Map","getLaFuncFromCache","getLaFuncFromMap","setLaFuncCache","setLaFuncCacheUsingMap","getLaFuncFromObj","setLaFuncUsingObj","preComputeLookaheadFunctions","rules","_this","currRule","TRACE_INIT","name","_a","alternation","repetition","option","repetitionMandatory","repetitionMandatoryWithSeparator","repetitionWithSeparator","currProd","prodIdx","idx","laFunc","hasPredicates","lookAheadBuilderForAlternatives","key","fullRuleNameToShort","computeLookaheadFunc","REPETITION","OPTION","REPETITION_MANDATORY","REPETITION_MANDATORY_WITH_SEPARATOR","REPETITION_WITH_SEPARATOR","rule","prodOccurrence","prodKey","prodType","prodMaxLookahead","dslMethodName","lookAheadBuilderForOptional","alt","tokenMatcher","alts","dslMethodIdx","occurrence","currRuleShortName","getLastExplicitRuleShortName","undefined","get","value","set"],"sources":["../../../../../src/parse/parser/traits/looksahead.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}